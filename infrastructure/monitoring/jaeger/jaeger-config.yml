# Jaeger configuration for distributed tracing
apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-config
  namespace: monitoring
data:
  jaeger.yml: |
    # Jaeger Collector configuration
    collector:
      zipkin:
        host-port: ":9411"
      otlp:
        grpc:
          host-port: ":14250"
        http:
          host-port: ":14268"
      
    # Storage configuration
    storage:
      type: elasticsearch
      elasticsearch:
        server-urls: http://elasticsearch:9200
        index-prefix: jaeger
        create-index-templates: true
        version: 7
        max-span-age: 72h
        num-shards: 5
        num-replicas: 1
        bulk:
          size: 5000000
          workers: 1
          flush-interval: 200ms
        timeout: 0s
        sniffer: false
        sniffer-tls-enabled: false
        tags-as-fields:
          all: false
          include: "http.method,http.status_code,component,db.type,db.instance"
        username: ""
        password: ""
        token-file: ""
        tls:
          enabled: false
          cert: ""
          key: ""
          ca: ""
          server-name: ""
          client-cert-key: ""
          skip-host-verify: false

    # Query service configuration
    query:
      base-path: /
      static-files: /go/jaeger-ui/
      ui-config: /etc/jaeger/ui-config.json
      max-clock-skew-adjustment: 0s

    # Agent configuration
    agent:
      jaeger:
        thrift-compact:
          host-port: ":6831"
        thrift-binary:
          host-port: ":6832"
        thrift-http:
          host-port: ":14268"
      zipkin:
        thrift:
          host-port: ":5775"

  ui-config.json: |
    {
      "monitor": {
        "menuEnabled": true
      },
      "dependencies": {
        "menuEnabled": true
      },
      "archiveEnabled": true,
      "tracking": {
        "gaID": "UA-000000-2",
        "trackErrors": true
      },
      "menu": [
        {
          "label": "About Jaeger",
          "items": [
            {
              "label": "GitHub",
              "url": "https://github.com/jaegertracing/jaeger"
            },
            {
              "label": "Docs",
              "url": "https://www.jaegertracing.io/docs/"
            }
          ]
        }
      ],
      "linkPatterns": [
        {
          "type": "logs",
          "key": "customer_id",
          "url": "http://example.com/logs/customer/#{customer_id}",
          "text": "View customer logs"
        }
      ]
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger-all-in-one
  namespace: monitoring
  labels:
    app: jaeger
    component: all-in-one
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
      component: all-in-one
  template:
    metadata:
      labels:
        app: jaeger
        component: all-in-one
    spec:
      containers:
        - name: jaeger
          image: jaegertracing/all-in-one:1.50
          ports:
            - containerPort: 16686
              protocol: TCP
              name: query-http
            - containerPort: 14268
              protocol: TCP
              name: collector-http
            - containerPort: 14250
              protocol: TCP
              name: collector-grpc
            - containerPort: 6831
              protocol: UDP
              name: agent-compact
            - containerPort: 6832
              protocol: UDP
              name: agent-binary
            - containerPort: 5775
              protocol: UDP
              name: agent-zipkin
            - containerPort: 9411
              protocol: TCP
              name: zipkin
          env:
            - name: COLLECTOR_OTLP_ENABLED
              value: 'true'
            - name: COLLECTOR_ZIPKIN_HOST_PORT
              value: ':9411'
            - name: SPAN_STORAGE_TYPE
              value: 'memory'
            - name: JAEGER_DISABLED
              value: 'false'
            - name: COLLECTOR_OTLP_GRPC_HOST_PORT
              value: ':14250'
            - name: COLLECTOR_OTLP_HTTP_HOST_PORT
              value: ':14268'
          volumeMounts:
            - name: jaeger-config
              mountPath: /etc/jaeger
          resources:
            requests:
              memory: '256Mi'
              cpu: '100m'
            limits:
              memory: '512Mi'
              cpu: '200m'
          livenessProbe:
            httpGet:
              path: /
              port: 16686
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: 16686
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: jaeger-config
          configMap:
            name: jaeger-config

---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-service
  namespace: monitoring
  labels:
    app: jaeger
    component: all-in-one
spec:
  selector:
    app: jaeger
    component: all-in-one
  ports:
    - name: query-http
      port: 16686
      targetPort: 16686
      protocol: TCP
    - name: collector-http
      port: 14268
      targetPort: 14268
      protocol: TCP
    - name: collector-grpc
      port: 14250
      targetPort: 14250
      protocol: TCP
    - name: agent-compact
      port: 6831
      targetPort: 6831
      protocol: UDP
    - name: agent-binary
      port: 6832
      targetPort: 6832
      protocol: UDP
    - name: zipkin
      port: 9411
      targetPort: 9411
      protocol: TCP
  type: ClusterIP
