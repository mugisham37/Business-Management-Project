# Infrastructure alerting rules
groups:
  - name: infrastructure.rules
    rules:
      # Node/Instance Rules
      - alert: NodeDown
        expr: up{job="node-exporter"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Node is down'
          description: 'Node {{ $labels.instance }} has been down for more than 1 minute'

      - alert: NodeHighCPUUsage
        expr: |
          (
            100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          ) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High CPU usage detected'
          description: 'CPU usage is {{ $value }}% on {{ $labels.instance }}'

      - alert: NodeHighMemoryUsage
        expr: |
          (
            (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes
          ) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High memory usage detected'
          description: 'Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}'

      - alert: NodeHighDiskUsage
        expr: |
          (
            (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes
          ) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High disk usage detected'
          description: 'Disk usage is {{ $value | humanizePercentage }} on {{ $labels.instance }} ({{ $labels.mountpoint }})'

      - alert: NodeHighDiskIOWait
        expr: |
          rate(node_cpu_seconds_total{mode="iowait"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High disk I/O wait detected'
          description: 'Disk I/O wait is {{ $value | humanizePercentage }} on {{ $labels.instance }}'

      # Kubernetes Rules
      - alert: KubernetesPodCrashLooping
        expr: |
          rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Pod is crash looping'
          description: 'Pod {{ $labels.namespace }}/{{ $labels.pod }} is crash looping'

      - alert: KubernetesPodNotReady
        expr: |
          kube_pod_status_ready{condition="false"} == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'Pod is not ready'
          description: 'Pod {{ $labels.namespace }}/{{ $labels.pod }} is not ready'

      - alert: KubernetesNodeNotReady
        expr: |
          kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Kubernetes node is not ready'
          description: 'Node {{ $labels.node }} is not ready'

      - alert: KubernetesDeploymentReplicasMismatch
        expr: |
          kube_deployment_spec_replicas != kube_deployment_status_available_replicas
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'Deployment replicas mismatch'
          description: 'Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has {{ $labels.spec_replicas }} desired but {{ $labels.available_replicas }} available replicas'

      # Load Balancer Rules
      - alert: LoadBalancerDown
        expr: |
          probe_success{job="blackbox"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'Load balancer endpoint is down'
          description: 'Load balancer endpoint {{ $labels.instance }} is down'

      - alert: LoadBalancerHighLatency
        expr: |
          probe_duration_seconds{job="blackbox"} > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'Load balancer high latency'
          description: 'Load balancer endpoint {{ $labels.instance }} latency is {{ $value }}s'

      # SSL Certificate Rules
      - alert: SSLCertificateExpiringSoon
        expr: |
          probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'SSL certificate expiring soon'
          description: 'SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}'

      - alert: SSLCertificateExpired
        expr: |
          probe_ssl_earliest_cert_expiry - time() <= 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: 'SSL certificate expired'
          description: 'SSL certificate for {{ $labels.instance }} has expired'
